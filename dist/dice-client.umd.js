(function(o,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(o=typeof globalThis<"u"?globalThis:o||self,c(o.DiceClient={}))})(this,function(o){"use strict";const c="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let r=(l=21)=>{let s="",e=crypto.getRandomValues(new Uint8Array(l));for(;l--;)s+=c[e[l]&63];return s};const a=[1],i=(l,...s)=>l&&console.debug("[DC Debug]:",...s),p={type:"Pong"};class R{constructor(s={},e=!1){this.webSocketReady=!1,this.pendingRollRequests={},this.debug=e,this.eventCallbacks=s}connect(s){this.disconnect(),this.webSocket=new WebSocket(s),this.webSocket.onopen=()=>{var e,t;this.webSocketReady=!0,(t=(e=this.eventCallbacks).onOpen)==null||t.call(e)},this.webSocket.onmessage=e=>{var n,d,u,h;let t=JSON.parse(e.data.toString());switch(i(this.debug,"Received message",t),t.type){case"ServerVersion":{a.includes(t.version)||(i(!0,"Unsupported server version! Supported versions are",a,"Closing connection."),(d=(n=this.eventCallbacks).onError)==null||d.call(n,new Error("Unsupported server version")),this.disconnect());break}case"SupportedDice":{this.supportedDice=t.dice,(h=(u=this.eventCallbacks).onSupportedDiceUpdated)==null||h.call(u,t.dice);break}case"RollResponse":{this.handleRollResponse(t.id,t.rolls);break}case"Ping":{this.send(p);break}}},this.webSocket.onclose=()=>{var e,t;this.webSocketReady=!1,(t=(e=this.eventCallbacks).onClose)==null||t.call(e),i(this.debug,"Connection closed")}}disconnect(){this.webSocket&&(this.webSocketReady=!1,this.webSocket.close(),this.webSocket.onclose=null,this.webSocket.onmessage=null,this.webSocket.onopen=null,this.webSocket=void 0)}requestRoll(s){let e=r();for(;this.pendingRollRequests[e];)e=r();return this.send({type:"RollRequest",id:e,rolls:s}),this.pendingRollRequests[e]={},e}requestRollPromise(s){let e=r();for(;this.pendingRollRequests[e];)e=r();return this.send({type:"RollRequest",id:e,rolls:s}),{rollId:e,promise:new Promise(t=>{this.pendingRollRequests[e]={resolve:t}})}}cancelRollRequest(s){var t,n;if(!this.pendingRollRequests[s]){i(this.debug,`Got a cancel roll request but the roll request was not found ${s}`);return}const e=this.pendingRollRequests[s];e.resolve?e.resolve({completedRolls:[],cancelled:!0}):(n=(t=this.eventCallbacks).onRollCancelled)==null||n.call(t,s),delete this.pendingRollRequests[s],this.send({type:"CancelRollRequest",id:s})}send(s){if(!this.webSocket){i(this.debug,`Attempted to send a '${s.type}' message but the websocket is not connected.`);return}this.webSocket.send(JSON.stringify(s))}handleRollResponse(s,e){var n,d;if(!this.pendingRollRequests[s]){i(this.debug,`Got a roll response that wasn't requested or was cancelled ${s}`);return}const t=this.pendingRollRequests[s];t.resolve?t.resolve({completedRolls:e,cancelled:!1}):(d=(n=this.eventCallbacks).onRollResponse)==null||d.call(n,s,e),delete this.pendingRollRequests[s]}}o.DiceClient=R,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
